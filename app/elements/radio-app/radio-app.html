<link rel="import" href="../../bower_components/core-localstorage/core-localstorage.html">
<link rel="import" href="../../bower_components/core-selector/core-selector.html">

<polymer-element name="radio-app" attributes="">
  <template>
    <link rel="stylesheet" href="radio-app.css">
    <core-localstorage id="storage" name="stations" value="{{ stations }}"></core-localstorage>
    <audio-player id="player">
    </audio-player>
    <file-drop flex on-file-drop="{{ addStation }}">
      Drop <em>m3u</em> Playlists here.
    </file-drop>
    <core-selector selected="{{ selected }}" on-core-activate="{{ playStation }}" layout horizontal>
      <template repeat="{{ station in stations }}">
        <audio-source url="{{ station.url }}" name="{{ station.name }}">
          <paper-ripple fit></paper-ripple>
        </audio-source>
      </template>
    </core-selector>
  </template>
  <script>
    (function () {
      'use strict';

      var m3u = /(?:#EXTINF:-?\d*,(.*)\n)*(http.*)/g;

      /* jshint -W064 */
      Polymer({
      /* jshint +W064 */

      addStation: function(e, detail/*, target*/) {
          var content = detail.body;
          var match;
          while((match = m3u.exec(content)) !== null) {
            var /*entry = match[0],*/
                name = match[1],
                url = match[2];
            this.url = url;
            this.stations = this.stations || [];
            this.stations.push({
              name: name,
              url: url
            });
            this.$.storage.save();
          }
        },

        playStation: function(e, detail) {
          this.$.player.setStation(detail.item);
        }

      });

    })();
  </script>
</polymer-element>
